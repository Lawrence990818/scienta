<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Profile - EduSocial</title>
    <!-- Same CSS/JS includes as explore.html -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
    />
    <style>
      .profile-header {
        background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
        border-radius: 10px;
        color: white;
      }
      .profile-avatar {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        object-fit: cover;
        border: 5px solid white;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }
      .stat-card {
        border-radius: 10px;
        background: white;
        padding: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        text-align: center;
      }
      .stat-card .number {
        font-size: 24px;
        font-weight: bold;
        color: #4e73df;
      }
      .stat-card .label {
        font-size: 12px;
        text-transform: uppercase;
        color: #6c757d;
      }
      .nav-pills .nav-link {
        color: #495057;
        font-weight: 500;
      }
      .nav-pills .nav-link.active {
        background-color: #4e73df;
      }
      .edit-profile-btn {
        position: absolute;
        top: 20px;
        right: 20px;
      }
    </style>
  </head>
  <body>
    <!-- Navigation (same as index.html) -->

    <div class="container mt-4">
      <div class="profile-header p-4 p-md-5 mb-4 position-relative">
        <button class="btn btn-light edit-profile-btn" id="editProfileBtn">
          <i class="bi bi-pencil"></i> Edit Profile
        </button>

        <div class="row align-items-center">
          <div class="col-md-3 text-center">
            <img
              src="/static/images/default-avatar.png"
              class="profile-avatar mb-3"
              alt="Profile"
              id="profileAvatar"
            />
          </div>
          <div class="col-md-9">
            <h1 id="profileName">Loading...</h1>
            <p class="lead mb-4" id="profileBio">Loading bio...</p>

            <div class="row">
              <div class="col-4 col-md-2">
                <div class="stat-card">
                  <div class="number" id="postsCount">0</div>
                  <div class="label">Posts</div>
                </div>
              </div>
              <div class="col-4 col-md-2">
                <div class="stat-card">
                  <div class="number" id="coursesCount">0</div>
                  <div class="label">Courses</div>
                </div>
              </div>
              <div class="col-4 col-md-2">
                <div class="stat-card">
                  <div class="number" id="followersCount">0</div>
                  <div class="label">Followers</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-lg-3">
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">About</h5>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <h6>Bio</h6>
                <p id="profileBioText">No bio yet</p>
              </div>
              <div class="mb-3">
                <h6>Joined</h6>
                <p id="profileJoined">Loading...</p>
              </div>
              <div>
                <h6>Role</h6>
                <p id="profileRole">Loading...</p>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-9">
          <ul class="nav nav-pills mb-4" id="profileTabs">
            <li class="nav-item">
              <a class="nav-link active" data-bs-toggle="pill" href="#posts"
                >Posts</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" data-bs-toggle="pill" href="#courses"
                >Courses</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" data-bs-toggle="pill" href="#activity"
                >Activity</a
              >
            </li>
          </ul>

          <div class="tab-content">
            <div class="tab-pane fade show active" id="posts">
              <div id="userPosts">
                <!-- User posts will be loaded here -->
                <div class="text-center my-5">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="tab-pane fade" id="courses">
              <div id="userCourses">
                <!-- User courses will be loaded here -->
              </div>
            </div>
            <div class="tab-pane fade" id="activity">
              <div id="userActivity">
                <!-- User activity will be loaded here -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Profile Modal -->
    <div
      class="modal fade"
      id="editProfileModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit Profile</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="profileForm">
              <div class="row mb-3">
                <div class="col-md-6">
                  <label class="form-label">First Name</label>
                  <input type="text" class="form-control" id="firstNameInput" />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Last Name</label>
                  <input type="text" class="form-control" id="lastNameInput" />
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Username</label>
                <input type="text" class="form-control" id="usernameInput" />
              </div>
              <div class="mb-3">
                <label class="form-label">Bio</label>
                <textarea
                  class="form-control"
                  rows="3"
                  id="bioInput"
                ></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">Profile Picture</label>
                <input
                  type="file"
                  class="form-control"
                  id="avatarInput"
                  accept="image/*"
                />
                <small class="text-muted">Max size 2MB</small>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-primary" id="saveProfileBtn">
              Save Changes
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Load profile data
      async function loadProfileData() {
        try {
          const response = await fetch("/api/users/me", {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });

          if (!response.ok) {
            throw new Error("Failed to load profile");
          }

          const data = await response.json();

          // Update profile header
          document.getElementById("profileName").textContent =
            data.full_name || data.username;
          document.getElementById("profileBio").textContent =
            data.bio || "No bio yet";
          document.getElementById("profileAvatar").src =
            data.avatar || "/static/images/default-avatar.png";

          // Update stats
          document.getElementById("postsCount").textContent = data.stats.posts;
          document.getElementById("coursesCount").textContent =
            data.stats.courses;
          document.getElementById("followersCount").textContent =
            data.stats.followers;

          // Update about section
          document.getElementById("profileBioText").textContent =
            data.bio || "No bio yet";
          document.getElementById("profileJoined").textContent = new Date(
            data.joined_at
          ).toLocaleDateString();
          document.getElementById("profileRole").textContent = data.is_teacher
            ? "Educator"
            : "Student";

          // Load user posts
          loadUserPosts(data.id);
        } catch (error) {
          console.error("Error loading profile:", error);

          if (error.message === "Failed to load profile") {
            // Redirect to login if not authenticated
            window.location.href = "/login.html";
          }
        }
      }

      function loadUserPosts(userId) {
        // Implement user posts loading
      }

      // Initialize page
      document.addEventListener("DOMContentLoaded", () => {
        if (localStorage.getItem("token")) {
          loadProfileData();

          // Setup edit profile modal
          const editProfileBtn = document.getElementById("editProfileBtn");
          const editProfileModal = new bootstrap.Modal(
            document.getElementById("editProfileModal")
          );

          editProfileBtn.addEventListener("click", () => {
            editProfileModal.show();
          });

          // Save profile changes
          document
            .getElementById("saveProfileBtn")
            .addEventListener("click", async () => {
              // Implement profile update logic
            });
        } else {
          window.location.href = "/login.html";
        }
      });
    </script>
  </body>
</html>
