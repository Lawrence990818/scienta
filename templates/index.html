<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EduSocial - Education Platform</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.css"
    />
    <style>
      :root {
        --primary-color: #4e73df;
        --secondary-color: #f8f9fc;
        --accent-color: #2e59d9;
        --text-color: #5a5c69;
        --light-gray: #f8f9fa;
      }

      body {
        background-color: var(--secondary-color);
        color: var(--text-color);
        font-family: "Nunito", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, "Helvetica Neue", Arial, sans-serif;
      }

      .navbar {
        background-color: white;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
      }

      .navbar-brand {
        font-weight: 800;
        color: var(--primary-color);
        font-size: 1.5rem;
      }

      .main-content {
        margin-top: 2rem;
      }

      .sidebar {
        position: sticky;
        top: 1rem;
        height: calc(100vh - 2rem);
        overflow-y: auto;
      }

      .sidebar-card {
        border-radius: 0.5rem;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1);
        border: none;
      }

      .sidebar-header {
        background-color: var(--primary-color);
        color: white;
        border-radius: 0.5rem 0.5rem 0 0;
        padding: 1rem;
        font-weight: 600;
      }

      .post-card {
        border-radius: 0.5rem;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1);
        border: none;
        margin-bottom: 2rem;
        background-color: white;
      }

      .post-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #e3e6f0;
      }

      .post-body {
        padding: 1.5rem;
      }

      .post-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid #e3e6f0;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
      }

      .post-media {
        margin: 1rem 0;
        border-radius: 0.35rem;
        overflow: hidden;
      }

      .post-media img,
      .post-media video {
        max-width: 100%;
        max-height: 500px;
        display: block;
        margin: 0 auto;
      }

      .swiper {
        width: 100%;
        height: 100%;
      }

      .swiper-slide {
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #000;
      }

      .swiper-slide img {
        display: block;
        width: 100%;
        height: 100%;
        object-fit: contain;
      }

      .swiper-pagination-bullet-active {
        background-color: white;
      }

      .tag {
        display: inline-block;
        background-color: var(--light-gray);
        color: var(--text-color);
        padding: 0.25rem 0.5rem;
        border-radius: 0.35rem;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
        font-size: 0.8rem;
      }

      .comment-container {
        background-color: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1);
        margin-top: 2rem;
      }

      .comment {
        position: relative;
        margin-bottom: 1rem;
        padding: 1rem;
        background-color: var(--light-gray);
        border-radius: 0.5rem;
      }

      .comment-replies {
        margin-left: 3rem;
        padding-left: 1.5rem;
        border-left: 2px solid #ddd;
      }

      .comment-actions {
        font-size: 0.9rem;
        margin-top: 0.5rem;
      }

      .comment-actions a {
        text-decoration: none;
        margin-right: 1rem;
        color: var(--text-color);
      }

      .comment-actions a:hover {
        color: var(--primary-color);
      }

      .comment-actions a.text-primary {
        color: var(--primary-color) !important;
      }

      .avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
      }

      .reply-form {
        display: none;
        margin-top: 1rem;
      }

      .time-ago {
        font-size: 0.8rem;
        color: #858796;
      }

      .auth-forms {
        max-width: 500px;
        margin: 3rem auto;
      }

      .auth-card {
        border-radius: 0.5rem;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
      }

      .auth-header {
        background-color: var(--primary-color);
        color: white;
        border-radius: 0.5rem 0.5rem 0 0;
        padding: 1.5rem;
        text-align: center;
      }

      .auth-body {
        padding: 2rem;
      }

      .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
      }

      .btn-primary:hover {
        background-color: var(--accent-color);
        border-color: var(--accent-color);
      }

      .dropdown-menu {
        border: none;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
      }

      .dropdown-item:active {
        background-color: var(--light-gray);
        color: var(--text-color);
      }

      .user-profile-dropdown {
        display: flex;
        align-items: center;
      }

      .user-profile-dropdown img {
        margin-right: 0.5rem;
      }

      .create-post-card {
        background-color: white;
        border-radius: 0.5rem;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1);
        margin-bottom: 2rem;
        padding: 1.5rem;
      }

      .media-preview {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
      }

      .media-preview-item {
        position: relative;
        width: 100px;
        height: 100px;
        border-radius: 0.35rem;
        overflow: hidden;
      }

      .media-preview-item img,
      .media-preview-item video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .remove-media {
        position: absolute;
        top: 0.25rem;
        right: 0.25rem;
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        border: none;
        width: 1.5rem;
        height: 1.5rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }

      .pagination {
        justify-content: center;
        margin-top: 2rem;
      }

      .page-item.active .page-link {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
      }

      .page-link {
        color: var(--primary-color);
      }
    </style>
  </head>
  <body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light sticky-top">
      <div class="container">
        <a class="navbar-brand" href="#">EduSocial</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link active" href="#"
                ><i class="bi bi-house-door"></i> Home</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#"
                ><i class="bi bi-compass"></i> Explore</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#"
                ><i class="bi bi-book"></i> Courses</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#"
                ><i class="bi bi-people"></i> Community</a
              >
            </li>
          </ul>
          <div class="d-flex">
            <div class="input-group me-3">
              <input type="text" class="form-control" placeholder="Search..." />
              <button class="btn btn-outline-secondary" type="button">
                <i class="bi bi-search"></i>
              </button>
            </div>
            <div class="dropdown" id="user-dropdown">
              <button
                class="btn btn-outline-secondary dropdown-toggle d-flex align-items-center"
                type="button"
                id="dropdownMenuButton"
                data-bs-toggle="dropdown"
              >
                <img
                  src="/static/images/default-avatar.png"
                  alt="User"
                  class="user-avatar me-2"
                  id="navbar-avatar"
                />
                <span id="navbar-username">Guest</span>
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <a class="dropdown-item" href="#" id="profile-link"
                    ><i class="bi bi-person"></i> Profile</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="#"
                    ><i class="bi bi-gear"></i> Settings</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="#"
                    ><i class="bi bi-bookmark"></i> Saved</a
                  >
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                  <a class="dropdown-item" href="#" id="logout-btn"
                    ><i class="bi bi-box-arrow-right"></i> Logout</a
                  >
                </li>
              </ul>
            </div>
            <button class="btn btn-primary ms-2" id="auth-toggle">Login</button>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="container main-content">
      <div class="row">
        <!-- Sidebar -->
        <div class="col-lg-3 d-none d-lg-block">
          <div class="sidebar">
            <div class="card sidebar-card mb-4">
              <div class="sidebar-header">
                <i class="bi bi-person-circle me-2"></i> My Profile
              </div>
              <div class="card-body text-center">
                <img
                  src="/static/images/default-avatar.png"
                  alt="User"
                  class="user-avatar mb-3"
                  id="sidebar-avatar"
                />
                <h5 id="sidebar-username">Guest User</h5>
                <p class="text-muted small" id="sidebar-bio">
                  Login to view your profile
                </p>
                <div class="d-grid gap-2">
                  <button
                    class="btn btn-outline-primary btn-sm"
                    id="sidebar-profile-btn"
                  >
                    View Profile
                  </button>
                </div>
              </div>
            </div>

            <div class="card sidebar-card mb-4">
              <div class="sidebar-header">
                <i class="bi bi-bookmark me-2"></i> Quick Links
              </div>
              <div class="list-group list-group-flush">
                <a href="#" class="list-group-item list-group-item-action"
                  ><i class="bi bi-journal-text me-2"></i> My Courses</a
                >
                <a href="#" class="list-group-item list-group-item-action"
                  ><i class="bi bi-calendar-check me-2"></i> Upcoming Events</a
                >
                <a href="#" class="list-group-item list-group-item-action"
                  ><i class="bi bi-chat-square-text me-2"></i> Discussions</a
                >
                <a href="#" class="list-group-item list-group-item-action"
                  ><i class="bi bi-trophy me-2"></i> Achievements</a
                >
              </div>
            </div>

            <div class="card sidebar-card">
              <div class="sidebar-header">
                <i class="bi bi-tags me-2"></i> Popular Tags
              </div>
              <div class="card-body">
                <div class="d-flex flex-wrap" id="popular-tags">
                  <span class="tag">#mathematics</span>
                  <span class="tag">#programming</span>
                  <span class="tag">#science</span>
                  <span class="tag">#history</span>
                  <span class="tag">#literature</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Main Feed -->
        <div class="col-lg-6">
          <!-- Create Post Card (shown when logged in) -->
          <div class="create-post-card d-none" id="create-post-card">
            <div class="d-flex mb-3">
              <img
                src="/static/images/default-avatar.png"
                alt="User"
                class="user-avatar me-3"
                id="create-post-avatar"
              />
              <input
                type="text"
                class="form-control"
                id="post-title-input"
                placeholder="What are you sharing today?"
              />
            </div>
            <textarea
              class="form-control mb-3"
              id="post-content-input"
              rows="3"
              placeholder="Add details..."
            ></textarea>

            <!-- Media Upload -->
            <div class="mb-3">
              <label
                for="post-media-input"
                class="btn btn-outline-secondary btn-sm"
              >
                <i class="bi bi-image"></i> Add Media
              </label>
              <input
                type="file"
                id="post-media-input"
                class="d-none"
                multiple
                accept="image/*,video/*"
              />
              <button
                class="btn btn-outline-secondary btn-sm ms-2"
                id="add-tags-btn"
              >
                <i class="bi bi-tag"></i> Add Tags
              </button>
              <div class="tags-container mt-2 d-none" id="tags-container">
                <input
                  type="text"
                  class="form-control form-control-sm"
                  id="tags-input"
                  placeholder="Enter tags separated by commas"
                />
              </div>
            </div>

            <!-- Media Preview -->
            <div class="media-preview" id="media-preview"></div>

            <div class="d-flex justify-content-between align-items-center">
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="publish-check"
                  checked
                />
                <label class="form-check-label small" for="publish-check">
                  Publish immediately
                </label>
              </div>
              <button class="btn btn-primary" id="submit-post-btn">Post</button>
            </div>
          </div>

          <!-- Posts Feed -->
          <div id="posts-feed">
            <!-- Posts will be loaded here -->
            <div class="text-center my-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          </div>

          <!-- Pagination -->
          <nav
            aria-label="Posts pagination"
            class="d-none"
            id="posts-pagination"
          >
            <ul class="pagination">
              <li class="page-item disabled" id="prev-page">
                <a class="page-link" href="#" tabindex="-1">Previous</a>
              </li>
              <li class="page-item active">
                <a class="page-link" href="#">1</a>
              </li>
              <li class="page-item"><a class="page-link" href="#">2</a></li>
              <li class="page-item"><a class="page-link" href="#">3</a></li>
              <li class="page-item" id="next-page">
                <a class="page-link" href="#">Next</a>
              </li>
            </ul>
          </nav>
        </div>

        <!-- Right Sidebar -->
        <div class="col-lg-3 d-none d-lg-block">
          <div class="card sidebar-card mb-4">
            <div class="sidebar-header">
              <i class="bi bi-bell me-2"></i> Notifications
            </div>
            <div class="card-body">
              <div
                class="alert alert-info alert-dismissible fade show mb-3"
                role="alert"
              >
                <strong>New assignment</strong> posted in Mathematics 101
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="alert"
                ></button>
              </div>
              <div
                class="alert alert-success alert-dismissible fade show mb-3"
                role="alert"
              >
                <strong>3 new replies</strong> to your discussion post
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="alert"
                ></button>
              </div>
              <div
                class="alert alert-warning alert-dismissible fade show"
                role="alert"
              >
                <strong>Upcoming deadline</strong> for Science project
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="alert"
                ></button>
              </div>
            </div>
          </div>

          <div class="card sidebar-card">
            <div class="sidebar-header">
              <i class="bi bi-people me-2"></i> Top Educators
            </div>
            <div class="list-group list-group-flush">
              <a
                href="#"
                class="list-group-item list-group-item-action d-flex align-items-center"
              >
                <img
                  src="/static/images/teacher1.jpg"
                  alt="Teacher"
                  class="user-avatar me-3"
                />
                <div>
                  <h6 class="mb-0">Dr. Sarah Johnson</h6>
                  <small class="text-muted">Mathematics</small>
                </div>
              </a>
              <a
                href="#"
                class="list-group-item list-group-item-action d-flex align-items-center"
              >
                <img
                  src="/static/images/teacher2.jpg"
                  alt="Teacher"
                  class="user-avatar me-3"
                />
                <div>
                  <h6 class="mb-0">Prof. Michael Chen</h6>
                  <small class="text-muted">Computer Science</small>
                </div>
              </a>
              <a
                href="#"
                class="list-group-item list-group-item-action d-flex align-items-center"
              >
                <img
                  src="/static/images/teacher3.jpg"
                  alt="Teacher"
                  class="user-avatar me-3"
                />
                <div>
                  <h6 class="mb-0">Dr. Emily Wilson</h6>
                  <small class="text-muted">Literature</small>
                </div>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Auth Modals -->
    <div class="modal fade" id="authModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content auth-card">
          <div class="auth-header">
            <h5 class="modal-title" id="authModalTitle">Login to EduSocial</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="auth-body">
            <!-- Auth forms will be loaded here -->
            <div id="auth-forms-container">
              <div id="login-form">
                <form id="login-user-form">
                  <div class="mb-3">
                    <label for="login-username" class="form-label"
                      >Username</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="login-username"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label for="login-password" class="form-label"
                      >Password</label
                    >
                    <input
                      type="password"
                      class="form-control"
                      id="login-password"
                      required
                    />
                  </div>
                  <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary">Login</button>
                  </div>
                  <div class="text-center mt-3">
                    <a href="#" id="show-forgot-password">Forgot password?</a>
                    <span class="mx-2">|</span>
                    <a href="#" id="show-register">Create account</a>
                  </div>
                </form>
              </div>

              <div id="register-form" class="d-none">
                <form id="register-user-form" enctype="multipart/form-data">
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="register-username" class="form-label"
                        >Username</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="register-username"
                        required
                      />
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="register-email" class="form-label"
                        >Email</label
                      >
                      <input
                        type="email"
                        class="form-control"
                        id="register-email"
                        required
                      />
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="register-password" class="form-label"
                        >Password</label
                      >
                      <input
                        type="password"
                        class="form-control"
                        id="register-password"
                        required
                      />
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="register-fullname" class="form-label"
                        >Full Name</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="register-fullname"
                      />
                    </div>
                  </div>
                  <div class="mb-3">
                    <label for="register-bio" class="form-label">Bio</label>
                    <textarea
                      class="form-control"
                      id="register-bio"
                      rows="2"
                    ></textarea>
                  </div>
                  <div class="mb-3">
                    <label for="register-avatar" class="form-label"
                      >Profile Picture</label
                    >
                    <input
                      type="file"
                      class="form-control"
                      id="register-avatar"
                      accept="image/*"
                    />
                  </div>
                  <div class="mb-3 form-check">
                    <input
                      type="checkbox"
                      class="form-check-input"
                      id="register-is-teacher"
                    />
                    <label class="form-check-label" for="register-is-teacher"
                      >I'm an educator</label
                    >
                  </div>
                  <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary">
                      Register
                    </button>
                  </div>
                  <div class="text-center mt-3">
                    <a href="#" id="show-login"
                      >Already have an account? Login</a
                    >
                  </div>
                </form>
              </div>

              <div id="forgot-password-form" class="d-none">
                <form id="forgot-password-user-form">
                  <div class="mb-3">
                    <label for="forgot-email" class="form-label"
                      >Email Address</label
                    >
                    <input
                      type="email"
                      class="form-control"
                      id="forgot-email"
                      required
                    />
                  </div>
                  <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary">
                      Reset Password
                    </button>
                  </div>
                  <div class="text-center mt-3">
                    <a href="#" id="show-login-from-forgot">Back to Login</a>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Post Detail Modal -->
    <div class="modal fade" id="postModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="postModalTitle">Post Details</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body" id="postModalBody">
            <!-- Post content will be loaded here -->
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.js"></script>
    <script
      async
      src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS_CHTML"
    ></script>
    <script>
      // DOM elements
      const postsFeed = document.getElementById("posts-feed");
      const createPostCard = document.getElementById("create-post-card");
      const authModal = new bootstrap.Modal(
        document.getElementById("authModal")
      );
      const postModal = new bootstrap.Modal(
        document.getElementById("postModal")
      );
      const authFormsContainer = document.getElementById(
        "auth-forms-container"
      );
      const loginForm = document.getElementById("login-form");
      const registerForm = document.getElementById("register-form");
      const forgotPasswordForm = document.getElementById(
        "forgot-password-form"
      );
      const loginUserForm = document.getElementById("login-user-form");
      const registerUserForm = document.getElementById("register-user-form");
      const showRegister = document.getElementById("show-register");
      const showLogin = document.getElementById("show-login");
      const showForgotPassword = document.getElementById(
        "show-forgot-password"
      );
      const showLoginFromForgot = document.getElementById(
        "show-login-from-forgot"
      );
      const authToggle = document.getElementById("auth-toggle");
      const userDropdown = document.getElementById("user-dropdown");
      const logoutBtn = document.getElementById("logout-btn");
      const profileLink = document.getElementById("profile-link");
      const navbarAvatar = document.getElementById("navbar-avatar");
      const navbarUsername = document.getElementById("navbar-username");
      const sidebarAvatar = document.getElementById("sidebar-avatar");
      const sidebarUsername = document.getElementById("sidebar-username");
      const sidebarBio = document.getElementById("sidebar-bio");
      const sidebarProfileBtn = document.getElementById("sidebar-profile-btn");
      const createPostAvatar = document.getElementById("create-post-avatar");
      const postTitleInput = document.getElementById("post-title-input");
      const postContentInput = document.getElementById("post-content-input");
      const postMediaInput = document.getElementById("post-media-input");
      const mediaPreview = document.getElementById("media-preview");
      const submitPostBtn = document.getElementById("submit-post-btn");
      const addTagsBtn = document.getElementById("add-tags-btn");
      const tagsContainer = document.getElementById("tags-container");
      const tagsInput = document.getElementById("tags-input");
      const postsPagination = document.getElementById("posts-pagination");
      const prevPageBtn = document.getElementById("prev-page");
      const nextPageBtn = document.getElementById("next-page");

      // Current user state
      let currentUser = null;
      let authToken = null;
      let currentPage = 1;
      let totalPages = 1;
      let mediaFiles = [];

      // Initialize Swiper for media carousel
      let postSwiper = null;

      // Initialize the app
      document.addEventListener("DOMContentLoaded", () => {
        checkAuthStatus().then(() => {
          loadPosts();
        });

        // Set up event listeners
        setupEventListeners();
      });

      function setupEventListeners() {
        // Auth form toggles
        showRegister.addEventListener("click", (e) => {
          e.preventDefault();
          loginForm.classList.add("d-none");
          registerForm.classList.remove("d-none");
          forgotPasswordForm.classList.add("d-none");
        });

        showLogin.addEventListener("click", (e) => {
          e.preventDefault();
          registerForm.classList.add("d-none");
          loginForm.classList.remove("d-none");
          forgotPasswordForm.classList.add("d-none");
        });

        showForgotPassword.addEventListener("click", (e) => {
          e.preventDefault();
          loginForm.classList.add("d-none");
          registerForm.classList.add("d-none");
          forgotPasswordForm.classList.remove("d-none");
        });

        showLoginFromForgot.addEventListener("click", (e) => {
          e.preventDefault();
          forgotPasswordForm.classList.add("d-none");
          loginForm.classList.remove("d-none");
        });

        // Auth toggle
        authToggle.addEventListener("click", () => {
          if (currentUser) {
            // Logout
            logoutUser();
          } else {
            // Show login modal
            authModal.show();
          }
        });

        // Logout button
        logoutBtn.addEventListener("click", (e) => {
          e.preventDefault();
          logoutUser();
        });

        // Profile link
        profileLink.addEventListener("click", (e) => {
          e.preventDefault();
          if (currentUser) {
            // TODO: Navigate to profile page
            alert(`Navigating to profile of ${currentUser.username}`);
          }
        });

        // Sidebar profile button
        sidebarProfileBtn.addEventListener("click", () => {
          if (currentUser) {
            // TODO: Navigate to profile page
            alert(`Navigating to profile of ${currentUser.username}`);
          } else {
            authModal.show();
          }
        });

        // Post media input
        postMediaInput.addEventListener("change", handleMediaUpload);

        // Add tags button
        addTagsBtn.addEventListener("click", (e) => {
          e.preventDefault();
          tagsContainer.classList.toggle("d-none");
        });

        // Submit post button
        submitPostBtn.addEventListener("click", submitPost);

        // Pagination
        prevPageBtn.addEventListener("click", (e) => {
          e.preventDefault();
          if (currentPage > 1) {
            currentPage--;
            loadPosts();
          }
        });

        nextPageBtn.addEventListener("click", (e) => {
          e.preventDefault();
          if (currentPage < totalPages) {
            currentPage++;
            loadPosts();
          }
        });
      }

      // Check authentication status
      function checkAuthStatus() {
        return new Promise((resolve) => {
          const token = localStorage.getItem("authToken");
          if (token) {
            // Verify token with server
            fetch("/api/auth/status", {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            })
              .then((response) => {
                if (response.ok) {
                  return response.json();
                }
                throw new Error("Not authenticated");
              })
              .then((data) => {
                currentUser = data.user;
                authToken = token;
                updateAuthUI();
                resolve();
              })
              .catch((error) => {
                localStorage.removeItem("authToken");
                currentUser = null;
                authToken = null;
                updateAuthUI();
                resolve();
              });
          } else {
            updateAuthUI();
            resolve();
          }
        });
      }

      // Update UI based on auth status
      function updateAuthUI() {
        if (currentUser) {
          // Update navbar
          authToggle.classList.add("d-none");
          userDropdown.classList.remove("d-none");
          navbarUsername.textContent = currentUser.username;
          navbarAvatar.src =
            currentUser.avatar || "/static/images/default-avatar.png";

          // Update sidebar
          sidebarUsername.textContent =
            currentUser.full_name || currentUser.username;
          sidebarBio.textContent =
            currentUser.bio || "Welcome to your profile!";
          sidebarAvatar.src =
            currentUser.avatar || "/static/images/default-avatar.png";

          // Update create post section
          createPostCard.classList.remove("d-none");
          createPostAvatar.src =
            currentUser.avatar || "/static/images/default-avatar.png";
        } else {
          // Update navbar
          authToggle.classList.remove("d-none");
          userDropdown.classList.add("d-none");
          navbarUsername.textContent = "Guest";
          navbarAvatar.src = "/static/images/default-avatar.png";

          // Update sidebar
          sidebarUsername.textContent = "Guest User";
          sidebarBio.textContent = "Login to view your profile";
          sidebarAvatar.src = "/static/images/default-avatar.png";

          // Update create post section
          createPostCard.classList.add("d-none");
        }
      }

      // Login user
      loginUserForm.addEventListener("submit", function (e) {
        e.preventDefault();
        const username = document.getElementById("login-username").value;
        const password = document.getElementById("login-password").value;

        fetch("/api/auth/login", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ username, password }),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Login failed");
            }
            return response.json();
          })
          .then((data) => {
            localStorage.setItem("authToken", data.token);
            currentUser = data.user;
            authToken = data.token;
            updateAuthUI();
            authModal.hide();
            loginUserForm.reset();
            loadPosts();
          })
          .catch((error) => {
            alert(error.message);
          });
      });

      // Register user
      registerUserForm.addEventListener("submit", function (e) {
        e.preventDefault();
        const formData = new FormData();

        formData.append(
          "username",
          document.getElementById("register-username").value
        );
        formData.append(
          "email",
          document.getElementById("register-email").value
        );
        formData.append(
          "password",
          document.getElementById("register-password").value
        );
        formData.append(
          "full_name",
          document.getElementById("register-fullname").value
        );
        formData.append("bio", document.getElementById("register-bio").value);
        formData.append(
          "is_teacher",
          document.getElementById("register-is-teacher").checked
        );

        const avatarInput = document.getElementById("register-avatar");
        if (avatarInput.files.length > 0) {
          formData.append("avatar", avatarInput.files[0]);
        }

        fetch("/api/auth/register", {
          method: "POST",
          body: formData,
        })
          .then((response) => {
            if (!response.ok) {
              return response.json().then((err) => {
                throw new Error(err.message || "Registration failed");
              });
            }
            return response.json();
          })
          .then((data) => {
            alert("Registration successful! Please login.");
            registerForm.classList.add("d-none");
            loginForm.classList.remove("d-none");
            registerUserForm.reset();
          })
          .catch((error) => {
            alert(error.message);
          });
      });

      // Logout user
      function logoutUser() {
        localStorage.removeItem("authToken");
        currentUser = null;
        authToken = null;
        updateAuthUI();
        loadPosts();
      }

      // Load posts
      function loadPosts() {
        postsFeed.innerHTML = `
          <div class="text-center my-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        `;

        fetch(`/api/posts?page=${currentPage}`)
          .then((response) => response.json())
          .then((data) => {
            totalPages = data.pages;
            renderPosts(data.posts);
            updatePagination();
          })
          .catch((error) => {
            console.error("Error loading posts:", error);
            postsFeed.innerHTML = `
              <div class="alert alert-danger">
                Failed to load posts. Please try again later.
              </div>
            `;
          });
      }

      // Render posts to the feed
      function renderPosts(posts) {
        if (posts.length === 0) {
          postsFeed.innerHTML = `
            <div class="alert alert-info">
              No posts found. Be the first to share something!
            </div>
          `;
          return;
        }

        postsFeed.innerHTML = "";

        posts.forEach((post) => {
          const postElement = createPostElement(post);
          postsFeed.appendChild(postElement);
        });
      }

      // Create HTML for a single post
      function createPostElement(post) {
        const postDiv = document.createElement("div");
        postDiv.className = "post-card";
        postDiv.dataset.id = post.id;

        // Format date
        const postDate = new Date(post.created_at);
        const formattedDate = postDate.toLocaleDateString("en-US", {
          year: "numeric",
          month: "long",
          day: "numeric",
        });

        // Create media HTML if exists
        let mediaHTML = "";
        if (post.media && post.media.length > 0) {
          if (post.media.length === 1) {
            // Single media
            const media = post.media[0];
            if (media.type === "image") {
              mediaHTML = `
                <div class="post-media">
                  <img src="${media.url}" alt="Post media" class="img-fluid">
                </div>
              `;
            } else if (media.type === "video") {
              mediaHTML = `
                <div class="post-media">
                  <video controls class="img-fluid">
                    <source src="${media.url}" type="video/mp4">
                    Your browser does not support the video tag.
                  </video>
                </div>
              `;
            }
          } else {
            // Multiple media - carousel
            mediaHTML = `
              <div class="post-media">
                <div class="swiper post-media-swiper">
                  <div class="swiper-wrapper">
                    ${post.media
                      .map(
                        (media) => `
                      <div class="swiper-slide">
                        ${
                          media.type === "image"
                            ? `<img src="${media.url}" alt="Post media">`
                            : `<video controls>
                            <source src="${media.url}" type="video/mp4">
                            Your browser does not support the video tag.
                          </video>`
                        }
                      </div>
                    `
                      )
                      .join("")}
                  </div>
                  <div class="swiper-pagination"></div>
                  <div class="swiper-button-prev"></div>
                  <div class="swiper-button-next"></div>
                </div>
              </div>
            `;
          }
        }

        // Create tags HTML if exists
        let tagsHTML = "";
        if (post.tags && post.tags.length > 0) {
          tagsHTML = `
            <div class="mt-3">
              ${post.tags
                .map((tag) => `<span class="tag">#${tag}</span>`)
                .join("")}
            </div>
          `;
        }

        postDiv.innerHTML = `
          <div class="post-header d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <img src="${
                post.author.avatar || "/static/images/default-avatar.png"
              }" 
                   alt="${post.author.username}" 
                   class="user-avatar me-3">
              <div>
                <h6 class="mb-0">${
                  post.author.full_name || post.author.username
                }</h6>
                <small class="text-muted">
                  ${
                    post.author.is_teacher
                      ? '<i class="bi bi-patch-check-fill text-primary"></i> Educator'
                      : "Student"
                  } â€¢ ${formattedDate}
                </small>
              </div>
            </div>
            <div>
              <button class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-three-dots"></i>
              </button>
            </div>
          </div>
          <div class="post-body">
            <h5>${post.title}</h5>
            <p>${post.content}</p>
            ${mediaHTML}
            ${tagsHTML}
          </div>
          <div class="post-footer">
            <div class="d-flex justify-content-between">
              <div>
                <a href="#" class="like-post ${
                  post.is_liked ? "text-primary" : ""
                }" data-id="${post.id}">
                  <i class="bi bi-hand-thumbs-up${
                    post.is_liked ? "-fill" : ""
                  }"></i> 
                  Like (${post.likes})
                </a>
                <a href="#" class="ms-3 view-comments" data-id="${post.id}">
                  <i class="bi bi-chat"></i> 
                  Comment (${post.comment_count})
                </a>
              </div>
              <div>
                <span class="text-muted">
                  <i class="bi bi-eye"></i> ${post.views} views
                </span>
              </div>
            </div>
          </div>
        `;

        // Initialize Swiper if multiple media
        if (post.media && post.media.length > 1) {
          // We need to wait for the element to be in DOM before initializing Swiper
          setTimeout(() => {
            const swiperEl = postDiv.querySelector(".post-media-swiper");
            if (swiperEl) {
              new Swiper(swiperEl, {
                pagination: {
                  el: ".swiper-pagination",
                  clickable: true,
                },
                navigation: {
                  nextEl: ".swiper-button-next",
                  prevEl: ".swiper-button-prev",
                },
              });
            }
          }, 0);
        }

        // Add event listeners
        const likeBtn = postDiv.querySelector(".like-post");
        const viewCommentsBtn = postDiv.querySelector(".view-comments");

        likeBtn.addEventListener("click", function (e) {
          e.preventDefault();
          likePost(post.id);
        });

        viewCommentsBtn.addEventListener("click", function (e) {
          e.preventDefault();
          viewPostDetails(post.id);
        });

        return postDiv;
      }

      // Update pagination UI
      function updatePagination() {
        if (totalPages <= 1) {
          postsPagination.classList.add("d-none");
          return;
        }

        postsPagination.classList.remove("d-none");

        // Update previous button
        if (currentPage === 1) {
          prevPageBtn.classList.add("disabled");
        } else {
          prevPageBtn.classList.remove("disabled");
        }

        // Update next button
        if (currentPage === totalPages) {
          nextPageBtn.classList.add("disabled");
        } else {
          nextPageBtn.classList.remove("disabled");
        }

        // Update page numbers (simplified - in real app you'd want more sophisticated pagination)
        const pageItems = postsPagination.querySelectorAll(
          ".page-item:not(#prev-page):not(#next-page)"
        );
        pageItems.forEach((item) => item.remove());

        const paginationList = postsPagination.querySelector(".pagination");
        const prevPageItem = paginationList.querySelector("#prev-page");

        for (let i = 1; i <= totalPages; i++) {
          const pageItem = document.createElement("li");
          pageItem.className = `page-item ${i === currentPage ? "active" : ""}`;
          pageItem.innerHTML = `<a class="page-link" href="#">${i}</a>`;

          pageItem.addEventListener("click", (e) => {
            e.preventDefault();
            if (i !== currentPage) {
              currentPage = i;
              loadPosts();
            }
          });

          paginationList.insertBefore(pageItem, nextPageBtn);
        }
      }

      // Handle media upload
      function handleMediaUpload() {
        mediaFiles = Array.from(postMediaInput.files);
        mediaPreview.innerHTML = "";

        if (mediaFiles.length === 0) return;

        mediaFiles.forEach((file, index) => {
          const mediaItem = document.createElement("div");
          mediaItem.className = "media-preview-item";

          if (file.type.startsWith("image/")) {
            const reader = new FileReader();
            reader.onload = function (e) {
              mediaItem.innerHTML = `
                <img src="${e.target.result}" alt="Preview">
                <button class="remove-media" data-index="${index}">&times;</button>
              `;
            };
            reader.readAsDataURL(file);
          } else if (file.type.startsWith("video/")) {
            mediaItem.innerHTML = `
              <video>
                <source src="${URL.createObjectURL(file)}" type="${file.type}">
              </video>
              <button class="remove-media" data-index="${index}">&times;</button>
            `;
          }

          mediaPreview.appendChild(mediaItem);
        });

        // Add event listeners to remove buttons
        document.querySelectorAll(".remove-media").forEach((btn) => {
          btn.addEventListener("click", function () {
            const index = parseInt(this.dataset.index);
            mediaFiles.splice(index, 1);
            handleMediaUpload(); // Re-render
          });
        });
      }

      // Submit new post
      function submitPost() {
        if (!currentUser) {
          alert("Please login to create posts");
          return;
        }

        const title = postTitleInput.value.trim();
        const content = postContentInput.value.trim();
        const tags = tagsInput.value.trim();
        const isPublished = document.getElementById("publish-check").checked;

        if (!title && !content && mediaFiles.length === 0) {
          alert("Please add some content to your post");
          return;
        }

        const formData = new FormData();
        formData.append("title", title);
        formData.append("content", content);
        formData.append("tags", tags);
        formData.append("is_published", isPublished);

        mediaFiles.forEach((file, index) => {
          formData.append("media", file);
        });

        submitPostBtn.disabled = true;
        submitPostBtn.innerHTML =
          '<span class="spinner-border spinner-border-sm" role="status"></span> Posting...';

        fetch("/api/posts", {
          method: "POST",
          headers: {
            Authorization: `Bearer ${authToken}`,
          },
          body: formData,
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Failed to create post");
            }
            return response.json();
          })
          .then((data) => {
            // Reset form
            postTitleInput.value = "";
            postContentInput.value = "";
            tagsInput.value = "";
            mediaFiles = [];
            mediaPreview.innerHTML = "";
            tagsContainer.classList.add("d-none");

            // Reload posts
            currentPage = 1;
            loadPosts();
          })
          .catch((error) => {
            alert(error.message);
          })
          .finally(() => {
            submitPostBtn.disabled = false;
            submitPostBtn.textContent = "Post";
          });
      }

      // Like a post
      function likePost(postId) {
        if (!currentUser) {
          authModal.show();
          return;
        }

        fetch(`/api/posts/${postId}/like`, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${authToken}`,
            "Content-Type": "application/json",
          },
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Failed to like post");
            }
            return response.json();
          })
          .then((data) => {
            // Update like count in UI
            const likeElement = document.querySelector(
              `.post-card[data-id="${postId}"] .like-post`
            );
            if (likeElement) {
              const likeText = likeElement.textContent;
              const newLikeText = likeText.replace(
                /Like \(\d+\)/,
                `Like (${data.likes})`
              );
              likeElement.innerHTML = newLikeText;

              // Update icon
              const icon = likeElement.querySelector("i");
              if (data.action === "liked") {
                likeElement.classList.add("text-primary");
                icon.classList.remove("bi-hand-thumbs-up");
                icon.classList.add("bi-hand-thumbs-up-fill");
              } else {
                likeElement.classList.remove("text-primary");
                icon.classList.remove("bi-hand-thumbs-up-fill");
                icon.classList.add("bi-hand-thumbs-up");
              }
            }
          })
          .catch((error) => {
            console.error("Error liking post:", error);
          });
      }

      // View post details (opens modal)
      function viewPostDetails(postId) {
        fetch(`/api/posts/${postId}`)
          .then((response) => response.json())
          .then((post) => {
            // Format date
            const postDate = new Date(post.created_at);
            const formattedDate = postDate.toLocaleDateString("en-US", {
              year: "numeric",
              month: "long",
              day: "numeric",
              hour: "2-digit",
              minute: "2-digit",
            });

            // Create media HTML if exists
            let mediaHTML = "";
            if (post.media && post.media.length > 0) {
              if (post.media.length === 1) {
                // Single media
                const media = post.media[0];
                if (media.type === "image") {
                  mediaHTML = `
                    <div class="post-media">
                      <img src="${media.url}" alt="Post media" class="img-fluid">
                    </div>
                  `;
                } else if (media.type === "video") {
                  mediaHTML = `
                    <div class="post-media">
                      <video controls class="img-fluid" style="max-height: 500px;">
                        <source src="${media.url}" type="video/mp4">
                        Your browser does not support the video tag.
                      </video>
                    </div>
                  `;
                }
              } else {
                // Multiple media - carousel
                mediaHTML = `
                  <div class="post-media">
                    <div class="swiper post-media-swiper">
                      <div class="swiper-wrapper">
                        ${post.media
                          .map(
                            (media) => `
                          <div class="swiper-slide">
                            ${
                              media.type === "image"
                                ? `<img src="${media.url}" alt="Post media">`
                                : `<video controls style="max-height: 500px;">
                                <source src="${media.url}" type="video/mp4">
                                Your browser does not support the video tag.
                              </video>`
                            }
                          </div>
                        `
                          )
                          .join("")}
                      </div>
                      <div class="swiper-pagination"></div>
                      <div class="swiper-button-prev"></div>
                      <div class="swiper-button-next"></div>
                    </div>
                  </div>
                `;
              }
            }

            // Create tags HTML if exists
            let tagsHTML = "";
            if (post.tags && post.tags.length > 0) {
              tagsHTML = `
                <div class="mt-3">
                  ${post.tags
                    .map((tag) => `<span class="tag">#${tag}</span>`)
                    .join("")}
                </div>
              `;
            }

            // Create comments HTML
            let commentsHTML = `
              <div class="comment-container mt-4">
                <h5>Comments (${post.comment_count})</h5>
                <div id="post-comments">
                  <div class="text-center my-3">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                  </div>
                </div>
                
                ${
                  currentUser
                    ? `
                <div class="mt-4">
                  <form id="add-comment-form">
                    <div class="mb-3">
                      <textarea class="form-control" id="comment-text" rows="3" placeholder="Add a comment..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Post Comment</button>
                  </form>
                </div>
                `
                    : `
                <div class="alert alert-info mt-4">
                  Please <a href="#" class="alert-link" id="login-from-comment">login</a> to comment.
                </div>
                `
                }
              </div>
            `;

            // Set modal content
            document.getElementById("postModalTitle").textContent = post.title;
            document.getElementById("postModalBody").innerHTML = `
              <div class="post-card">
                <div class="post-header d-flex justify-content-between align-items-center">
                  <div class="d-flex align-items-center">
                    <img src="${
                      post.author.avatar || "/static/images/default-avatar.png"
                    }" 
                         alt="${post.author.username}" 
                         class="user-avatar me-3">
                    <div>
                      <h6 class="mb-0">${
                        post.author.full_name || post.author.username
                      }</h6>
                      <small class="text-muted">
                        ${
                          post.author.is_teacher
                            ? '<i class="bi bi-patch-check-fill text-primary"></i> Educator'
                            : "Student"
                        } â€¢ ${formattedDate}
                      </small>
                    </div>
                  </div>
                  <div>
                    <button class="btn btn-sm btn-outline-secondary">
                      <i class="bi bi-three-dots"></i>
                    </button>
                  </div>
                </div>
                <div class="post-body">
                  <p>${post.content}</p>
                  ${mediaHTML}
                  ${tagsHTML}
                </div>
                <div class="post-footer">
                  <div class="d-flex justify-content-between">
                    <div>
                      <a href="#" class="like-post ${
                        post.is_liked ? "text-primary" : ""
                      }" data-id="${post.id}">
                        <i class="bi bi-hand-thumbs-up${
                          post.is_liked ? "-fill" : ""
                        }"></i> 
                        Like (${post.likes})
                      </a>
                    </div>
                    <div>
                      <span class="text-muted">
                        <i class="bi bi-eye"></i> ${post.views} views
                      </span>
                    </div>
                  </div>
                </div>
              </div>
              ${commentsHTML}
            `;

            // Show modal
            postModal.show();

            // Initialize Swiper if multiple media
            if (post.media && post.media.length > 1) {
              setTimeout(() => {
                const swiperEl = document.querySelector(
                  "#postModalBody .post-media-swiper"
                );
                if (swiperEl) {
                  postSwiper = new Swiper(swiperEl, {
                    pagination: {
                      el: ".swiper-pagination",
                      clickable: true,
                    },
                    navigation: {
                      nextEl: ".swiper-button-next",
                      prevEl: ".swiper-button-prev",
                    },
                  });
                }
              }, 0);
            }

            // Load comments
            loadPostComments(post.id);

            // Add event listeners
            const likeBtn = document.querySelector("#postModalBody .like-post");
            if (likeBtn) {
              likeBtn.addEventListener("click", function (e) {
                e.preventDefault();
                likePost(post.id);
              });
            }

            const addCommentForm = document.getElementById("add-comment-form");
            if (addCommentForm) {
              addCommentForm.addEventListener("submit", function (e) {
                e.preventDefault();
                const content = document
                  .getElementById("comment-text")
                  .value.trim();
                if (content) {
                  postComment(post.id, content);
                }
              });
            }

            const loginFromComment =
              document.getElementById("login-from-comment");
            if (loginFromComment) {
              loginFromComment.addEventListener("click", function (e) {
                e.preventDefault();
                postModal.hide();
                authModal.show();
              });
            }
          })
          .catch((error) => {
            console.error("Error loading post:", error);
          });
      }

      // Load comments for a post
      function loadPostComments(postId) {
        const headers = {};
        if (authToken) {
          headers["Authorization"] = `Bearer ${authToken}`;
        }

        fetch(`/api/comments?post_id=${postId}`, {
          headers: headers,
        })
          .then((response) => response.json())
          .then((comments) => {
            renderComments(comments);
          })
          .catch((error) => {
            console.error("Error loading comments:", error);
            document.getElementById("post-comments").innerHTML = `
              <div class="alert alert-danger">
                Failed to load comments. Please try again later.
              </div>
            `;
          });
      }

      // Render comments
      function renderComments(comments, parentElement = null) {
        const container =
          parentElement || document.getElementById("post-comments");
        if (!container) return;

        if (comments.length === 0) {
          container.innerHTML = `
            <div class="alert alert-info">
              No comments yet. Be the first to comment!
            </div>
          `;
          return;
        }

        container.innerHTML = "";

        comments.forEach((comment) => {
          const commentElement = createCommentElement(comment);
          container.appendChild(commentElement);

          // Render replies if they exist
          if (comment.replies && comment.replies.length > 0) {
            const repliesContainer = document.createElement("div");
            repliesContainer.className = "comment-replies";
            commentElement.appendChild(repliesContainer);
            renderComments(comment.replies, repliesContainer);
          }
        });
      }

      // Create HTML for a single comment
      function createCommentElement(comment) {
        const timeAgo = formatTimeAgo(comment.timestamp);
        const canDelete =
          currentUser &&
          (currentUser.id === comment.user_id || currentUser.is_admin);

        const commentDiv = document.createElement("div");
        commentDiv.className = "comment";
        commentDiv.dataset.id = comment.id;

        commentDiv.innerHTML = `
          <div class="d-flex">
            <div class="flex-shrink-0 me-3">
              <img src="${
                comment.avatar || "/static/images/default-avatar.png"
              }" 
                   alt="${comment.username}" 
                   class="avatar">
            </div>
            <div class="flex-grow-1">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <h6 class="mb-0 fw-bold">${comment.username}</h6>
                <span class="time-ago">${timeAgo}</span>
              </div>
              <p class="mb-2">${comment.content}</p>
              <div class="comment-actions">
                <a href="#" class="like-comment ${
                  comment.is_liked ? "text-primary" : ""
                }" data-id="${comment.id}">
                  <i class="bi bi-hand-thumbs-up${
                    comment.is_liked ? "-fill" : ""
                  }"></i> 
                  Like (<span class="like-count">${comment.likes}</span>)
                </a>
                <a href="#" class="reply-link" data-id="${comment.id}">
                  <i class="bi bi-reply"></i> Reply
                </a>
                ${
                  canDelete
                    ? `
                <a href="#" class="delete-comment text-danger" data-id="${comment.id}">
                  <i class="bi bi-trash"></i> Delete
                </a>
                `
                    : ""
                }
              </div>
              
              <!-- Reply form (hidden by default) -->
              <div class="reply-form card mt-3">
                <div class="card-body p-2">
                  <form class="reply-form-inner">
                    <div class="mb-2">
                      <textarea class="form-control form-control-sm reply-content" 
                                rows="2" 
                                placeholder="Write a reply..." 
                                required></textarea>
                    </div>
                    <div class="d-flex justify-content-end">
                      <button type="button" class="btn btn-outline-secondary btn-sm me-2 cancel-reply">
                        Cancel
                      </button>
                      <button type="submit" class="btn btn-primary btn-sm">
                        Reply
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        `;

        // Add event listeners
        const likeBtn = commentDiv.querySelector(".like-comment");
        const replyLink = commentDiv.querySelector(".reply-link");
        const replyForm = commentDiv.querySelector(".reply-form");
        const cancelBtn = commentDiv.querySelector(".cancel-reply");
        const replyFormInner = commentDiv.querySelector(".reply-form-inner");
        const deleteLink = commentDiv.querySelector(".delete-comment");

        if (likeBtn) {
          likeBtn.addEventListener("click", function (e) {
            e.preventDefault();
            likeComment(comment.id);
          });
        }

        if (replyLink) {
          replyLink.addEventListener("click", function (e) {
            e.preventDefault();
            if (!currentUser) {
              authModal.show();
              return;
            }
            replyForm.style.display =
              replyForm.style.display === "block" ? "none" : "block";
          });
        }

        if (cancelBtn) {
          cancelBtn.addEventListener("click", function () {
            replyForm.style.display = "none";
          });
        }

        if (replyFormInner) {
          replyFormInner.addEventListener("submit", function (e) {
            e.preventDefault();

            if (!currentUser) {
              authModal.show();
              return;
            }

            const content = this.querySelector(".reply-content").value.trim();
            if (!content) return;

            postComment(comment.post_id, content, comment.id, function () {
              replyFormInner.reset();
              replyForm.style.display = "none";
            });
          });
        }

        if (deleteLink) {
          deleteLink.addEventListener("click", function (e) {
            e.preventDefault();
            if (confirm("Are you sure you want to delete this comment?")) {
              deleteComment(comment.id);
            }
          });
        }

        return commentDiv;
      }

      // Post a comment
      function postComment(postId, content, parentId = null, callback = null) {
        fetch("/api/comments", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${authToken}`,
          },
          body: JSON.stringify({
            post_id: postId,
            content: content,
            parent_id: parentId,
          }),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Failed to post comment");
            }
            return response.json();
          })
          .then((newComment) => {
            loadPostComments(postId);
            if (callback) callback();
          })
          .catch((error) => {
            console.error("Error posting comment:", error);
            alert("Error posting comment: " + error.message);
          });
      }

      // Like a comment
      function likeComment(commentId) {
        fetch(`/api/comments/${commentId}/like`, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${authToken}`,
            "Content-Type": "application/json",
          },
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Failed to like comment");
            }
            return response.json();
          })
          .then((data) => {
            // Update like count in UI
            const likeCountElement = document.querySelector(
              `.comment[data-id="${commentId}"] .like-count`
            );
            const likeBtn = document.querySelector(
              `.comment[data-id="${commentId}"] .like-comment`
            );
            const icon = likeBtn.querySelector("i");

            if (likeCountElement) {
              likeCountElement.textContent = data.likes;
            }

            // Update button appearance
            if (likeBtn) {
              if (data.action === "liked") {
                likeBtn.classList.add("text-primary");
                icon.classList.remove("bi-hand-thumbs-up");
                icon.classList.add("bi-hand-thumbs-up-fill");
              } else {
                likeBtn.classList.remove("text-primary");
                icon.classList.remove("bi-hand-thumbs-up-fill");
                icon.classList.add("bi-hand-thumbs-up");
              }
            }
          })
          .catch((error) => {
            console.error("Error liking comment:", error);
          });
      }

      // Delete a comment
      function deleteComment(commentId) {
        fetch(`/api/comments/${commentId}`, {
          method: "DELETE",
          headers: {
            Authorization: `Bearer ${authToken}`,
          },
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Failed to delete comment");
            }
            // Find the post ID from the comment element
            const commentElement = document.querySelector(
              `.comment[data-id="${commentId}"]`
            );
            if (commentElement) {
              // Traverse up to find the post modal
              let parent = commentElement.parentElement;
              while (parent && !parent.id === "post-comments") {
                parent = parent.parentElement;
              }

              if (parent && parent.id === "post-comments") {
                const postCard = parent.closest(".post-card");
                if (postCard) {
                  const postId = postCard.dataset.id;
                  if (postId) {
                    loadPostComments(postId);
                  }
                }
              }
            }
          })
          .catch((error) => {
            console.error("Error deleting comment:", error);
            alert("Error deleting comment: " + error.message);
          });
      }

      // Format time ago
      function formatTimeAgo(timestamp) {
        const now = new Date();
        const date = new Date(timestamp);
        const seconds = Math.floor((now - date) / 1000);

        if (seconds < 60) return "just now";
        if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
        if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
        if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
        return date.toLocaleDateString("en-US", {
          month: "short",
          day: "numeric",
        });
      }
      MathJax = {
        tex: {
          inlineMath: [
            ["$", "$"],
            ["\\(", "\\)"],
          ],
        },
        svg: {
          fontCache: "global",
        },
      };
    </script>
  </body>
</html>
